<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Permanent QR Generator by Heri Sanjaya</title>

    <!-- PWA and Mobile App Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="QR Gen">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/107/107132.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/107/107132.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>

    <style>
        /* === CORE LAYOUT FIXES === */
        html, body {
            position: fixed;
            overflow: hidden;
            overscroll-behavior: none;
            height: 100%;
            width: 100%;
            background-color: #000; /* FIX: Ensure root background is black */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard syntax */
        }

        body {
            font-family: 'Inter', sans-serif;
            /* background-color is inherited from the rule above */
            color: #e0e0e0;
        }
        
        #mainContent {
            overflow: hidden;
            min-height: 0;
        }

        .cinzel-font {
            font-family: 'Cinzel', serif;
        }

        .main-bg {
            background-color: #000; /* Solid black background */
        }

        /* === INPUT & BUTTON STYLES === */
        .premium-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .premium-input:focus {
            outline: none;
            border-color: rgba(220, 180, 100, 0.7);
            box-shadow: 0 0 15px rgba(220, 180, 100, 0.3);
        }
        
        .center-text-input {
            text-align: center;
        }
        
        .center-text-input::placeholder {
            text-align: center;
        }

        .premium-button {
            background: linear-gradient(45deg, #3a3a3a, #1a1a1a);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }

        .premium-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 180, 100, 0.2);
        }

        .premium-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* === OUTPUT CONTAINER STYLES === */
        .output-container {
            max-height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            visibility: hidden;
            height: 440px; /* Fixed height for both slider cards */
        }

        .output-container.visible {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        #qrcode {
            cursor: pointer;
        }

        /* === HORIZONTAL SLIDER STYLES === */
        .scroll-wrapper {
            width: 100%;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        .scroll-wrapper::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        .scroll-item {
            flex: 0 0 100%;
            scroll-snap-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* === DOT INDICATOR STYLES === */
        .dots-container {
            text-align: center;
            padding-bottom: 10px; /* Space between dots and slider */
        }

        .dot {
            cursor: pointer;
            height: 10px;
            width: 10px;
            margin: 0 4px;
            background-color: #4a4a4a;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.3s ease;
        }

        .dot.active {
            background-color: #e0e0e0;
        }

        /* === CHECKLIST MODAL STYLES === */
        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #9ca3af; /* gray-400 */
            transition: color 0.3s ease;
        }
        .checklist-item.completed {
            color: #e5e7eb; /* gray-200 */
        }
        .checklist-item .icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            stroke-width: 2;
            transition: all 0.3s ease;
        }
        .checklist-item .pending-icon {
            stroke: #6b7280; /* gray-500 */
        }
        .checklist-item .completed-icon {
            stroke: #34d399; /* green-400 */
            transform: scale(1);
        }
    </style>
</head>

<body id="mainBody"
    class="main-bg w-full h-full p-4 flex flex-col items-center">

    <div class="w-full max-w-xl mx-auto flex flex-col h-full">
        <!-- Header Section -->
        <header id="headerSection" class="text-center mb-8 md:mb-12 flex-shrink-0">
            <h1 class="cinzel-font text-3xl md:text-4xl font-bold text-white tracking-wider">Permanent's<br>QR Generator
            </h1>
        </header>

        <!-- Main Content Area -->
        <main id="mainContent" class="flex-grow relative flex flex-col">
            <!-- Initializing Modal -->
            <div id="initializingModal" class="absolute inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-10">
                <div class="w-48">
                    <div id="check-step-1" class="checklist-item">
                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <!-- Icon will be injected by JS -->
                        </svg>
                        <span>Checking License</span>
                    </div>
                    <div id="check-step-2" class="checklist-item">
                        <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <!-- Icon will be injected by JS -->
                        </svg>
                        <span>Verifying</span>
                    </div>
                </div>
            </div>

            <!-- License Section (Hidden by default) -->
            <div id="licenseSection" class="max-w-lg mx-auto hidden flex-grow flex flex-col justify-center">
                <div>
                    <h2 class="cinzel-font text-2xl font-bold text-white mb-4 text-center">Activate Your Product</h2>
                    <form id="licenseForm" class="flex flex-col gap-4">
                        <input type="email" id="emailInput" placeholder="Enter your email..."
                            class="premium-input center-text-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500 focus:ring-0" required>
                        <input type="text" id="licenseInput" placeholder="Enter your license code..."
                            class="premium-input center-text-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500 focus:ring-0" required>
                        <button type="submit" id="submitLicenseButton"
                            class="premium-button text-white font-semibold px-6 py-3 rounded-lg">Activate</button>
                    </form>
                    <p id="licenseErrorMessage" class="text-red-400 text-center mt-2 h-4"></p>
                </div>
            </div>

            <!-- QR Generator Section (Hidden by default) -->
            <div id="qrGeneratorSection" class="hidden flex flex-col flex-grow min-h-0">
                <!-- Input Form -->
                <div class="mb-8 md:mb-12 max-w-lg mx-auto flex-shrink-0">
                    <form id="qrForm" class="flex flex-col sm:flex-row gap-4">
                        <div class="w-full">
                            <input type="text" id="nameInput" placeholder="Enter spectator's name"
                                class="premium-input center-text-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500 focus:ring-0">
                            <p class="text-xs text-gray-500 text-center mt-2">(optional)</p>
                        </div>
                        <button type="submit" id="generateButton"
                            class="premium-button text-white font-semibold px-6 py-3 rounded-lg whitespace-nowrap w-full sm:w-auto">Generate</button>
                    </form>
                    <p id="errorMessage" class="text-red-400 text-center mt-2 h-4"></p>
                </div>

                <!-- Horizontal Slider Output -->
                <div id="outputSection" class="hidden flex-grow flex flex-col min-h-0">
                    <!-- Dot Indicators -->
                    <div id="dotsContainer" class="dots-container hidden flex-shrink-0">
                        <span class="dot active" data-index="0"></span>
                        <span class="dot" data-index="1"></span>
                    </div>
                    <!-- Slider Wrapper -->
                    <div id="scrollWrapper" class="scroll-wrapper flex-grow">
                        <!-- QR Code Card -->
                        <div class="scroll-item">
                            <div id="qrContainer"
                                class="output-container rounded-xl p-6 flex flex-col items-center justify-center w-full max-w-sm">
                                <h2 class="cinzel-font text-2xl font-bold text-white mb-4 text-center">Your QR Code</h2>
                                <div id="qrcode" class="bg-white p-4 rounded-lg shadow-lg w-64 h-64 flex items-center justify-center"></div>
                                <p class="text-gray-400 mt-4 text-center text-sm">Click the QR code to make it fullscreen.</p>
                                <p id="copyMessage" class="text-green-400 text-center mt-2 h-4 text-sm"></p>
                            </div>
                        </div>
                        <!-- Webpage Preview Card -->
                        <div class="scroll-item">
                            <div id="previewContainer" class="output-container rounded-xl p-6 flex flex-col items-center justify-center w-full max-w-sm">
                                <h2 class="cinzel-font text-2xl font-bold text-white mb-4 text-center">Page Preview</h2>
                                <div class="w-64 h-64 bg-black rounded-lg overflow-hidden border border-gray-700">
                                    <canvas id="previewCanvas" class="w-full h-full"></canvas>
                                </div>
                                <p class="text-gray-400 mt-4 text-center text-sm">A preview of what the spectator will see.</p>
                                <!-- FIX: Add a placeholder paragraph to balance the layout -->
                                <div class="h-4 mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Disclaimer -->
                <p id="disclaimerText" class="hidden text-center text-xs text-gray-500 mt-auto flex-shrink-0 pb-2">This page is only used to generate a QR code for your spectator. The actual routine does not require this app in play.</p>
            </div>
        </main>
    </div>

    <!-- Fullscreen QR Modal (Solid Black Background) -->
    <div id="fullscreenModal" class="fixed inset-0 bg-black flex items-center justify-center hidden z-50 p-4">
        <img src="https://img.icons8.com/sf-black/64/ffffff/delete-sign.png" alt="Close" id="closeModalButton" class="absolute top-5 right-5 w-10 h-10 cursor-pointer">
        <div id="fullscreenQrContainer" class="p-4 bg-white rounded-lg"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAjs_-oH_kma3lHU4BCyStN8W0606MYLus",
            authDomain: "permanentmagicapp.firebaseapp.com",
            projectId: "permanentmagicapp",
            storageBucket: "permanentmagicapp.firebasestorage.app",
            messagingSenderId: "695981452362",
            appId: "1:695981452362:web:a0155863e767fa63424ab3",
            databaseURL: "https://permanentmagicapp-default-rtdb.firebaseio.com"
        };

        let db, auth, firestore;
        let currentURL = '';
        let generatedUrl = null;
        let qrCanvasElement = null;

        const mainBody = document.getElementById('mainBody');
        const mainContent = document.getElementById('mainContent');
        const headerSection = document.getElementById('headerSection');
        const initializingModal = document.getElementById('initializingModal');
        const licenseSection = document.getElementById('licenseSection');
        const licenseForm = document.getElementById('licenseForm');
        const emailInput = document.getElementById('emailInput');
        const licenseInput = document.getElementById('licenseInput');
        const submitLicenseButton = document.getElementById('submitLicenseButton');
        const licenseErrorMessage = document.getElementById('licenseErrorMessage');
        const qrGeneratorSection = document.getElementById('qrGeneratorSection');
        const qrForm = document.getElementById('qrForm');
        const nameInput = document.getElementById('nameInput');
        const qrcodeContainer = document.getElementById('qrcode');
        const previewCanvas = document.getElementById('previewCanvas');
        const qrContainer = document.getElementById('qrContainer');
        const previewContainer = document.getElementById('previewContainer');
        const errorMessage = document.getElementById('errorMessage');
        const outputSection = document.getElementById('outputSection');
        const copyMessage = document.getElementById('copyMessage');
        const fullscreenModal = document.getElementById('fullscreenModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const fullscreenQrContainer = document.getElementById('fullscreenQrContainer');
        const scrollWrapper = document.getElementById('scrollWrapper');
        const dotsContainer = document.getElementById('dotsContainer');
        const dots = document.querySelectorAll('.dot');
        const disclaimerText = document.getElementById('disclaimerText');

        const symbols = [
            { name: 'Circle', draw: (c, x, y, s) => { c.arc(x, y, s * 0.35, 0, Math.PI * 2); } },
            { name: 'Cross', draw: (c, x, y, s) => { c.moveTo(x, y - s * 0.35); c.lineTo(x, y + s * 0.35); c.moveTo(x - s * 0.35, y); c.lineTo(x + s * 0.35, y); } },
            { name: 'Wavy Lines', draw: (c, x, y, s) => { for (let i = -1; i <= 1; i++) { c.moveTo(x - s * 0.3, y + s * 0.2 * i); c.quadraticCurveTo(x - s * 0.15, y + s * 0.2 * i - s * 0.2, x, y + s * 0.2 * i); c.quadraticCurveTo(x + s * 0.15, y + s * 0.2 * i + s * 0.2, x + s * 0.3, y + s * 0.2 * i); } } },
            { name: 'Square', draw: (c, x, y, s) => { c.rect(x - s * 0.35, y - s * 0.35, s * 0.7, s * 0.7); } },
            { name: 'Star', draw: (c, x, y, s) => { c.moveTo(x, y - s * 0.35); for (let i = 1; i < 5; i++) { c.lineTo(x + Math.sin(i * 0.8 * Math.PI) * s * 0.35, y - Math.cos(i * 0.8 * Math.PI) * s * 0.35); } c.closePath(); } }
        ];

        const iconPending = `<circle cx="12" cy="12" r="10" class="pending-icon" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="2, 4" />`;
        const iconCompleted = `<path class="completed-icon" stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />`;

        function updateChecklist(step, isComplete) {
            const item = document.getElementById(`check-step-${step}`);
            if (item) {
                const icon = item.querySelector('.icon');
                if (isComplete) {
                    item.classList.add('completed');
                    icon.innerHTML = iconCompleted;
                } else {
                    item.classList.remove('completed');
                    icon.innerHTML = iconPending;
                }
            }
        }

        function showApp() {
            initializingModal.classList.add('hidden');
            licenseSection.classList.add('hidden');
            qrGeneratorSection.classList.remove('hidden');
        }

        function showLicenseForm() {
            initializingModal.classList.add('hidden');
            qrGeneratorSection.classList.add('hidden');
            licenseSection.classList.remove('hidden');
        }
        
        async function initialize() {
            updateChecklist(1, false);
            updateChecklist(2, false);

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);
                firestore = getFirestore(app);
                await signInAnonymously(auth);

                const localEmail = localStorage.getItem('permanentMagicEmail');
                const localLicense = localStorage.getItem('permanentMagicLicenseCode');
                updateChecklist(1, true);

                if (localEmail && localLicense) {
                    const licenseDocRef = doc(firestore, "activatedLicenses", localEmail);
                    const docSnap = await getDoc(licenseDocRef);
                    updateChecklist(2, true);

                    if (docSnap.exists() && docSnap.data().licenseCode === localLicense) {
                        await startApp();
                    } else {
                        localStorage.removeItem('permanentMagicEmail');
                        localStorage.removeItem('permanentMagicLicenseCode');
                        showLicenseForm();
                    }
                } else {
                    updateChecklist(2, true); // Mark as complete even if skipped
                    showLicenseForm();
                }
            } catch (error) {
                console.error("Initialization failed:", error);
                showLicenseForm(); // Fallback to license form on major error
            }
        }

        async function startApp() {
            try {
                const configRef = ref(db, '/config');
                const snapshot = await get(configRef);
                if (snapshot.exists()) {
                    currentURL = snapshot.val().currentURL;
                    if (!currentURL) throw new Error("currentURL not found in database.");
                    showApp();
                    await generateAndDisplay("Guest"); // Generate initial content
                } else {
                    throw new Error("Configuration not found in database.");
                }
            } catch (error) {
                console.error("App startup failed:", error);
                showLicenseForm();
            }
        }

        async function handleLicenseSubmit(e) {
            e.preventDefault();
            const userLicense = licenseInput.value.trim();
            const userEmail = emailInput.value.trim();
            if (!userLicense || !userEmail) {
                licenseErrorMessage.textContent = "Please fill in both fields.";
                return;
            }
            submitLicenseButton.disabled = true;
            submitLicenseButton.textContent = "Verifying...";
            licenseErrorMessage.textContent = "";
            try {
                const licensesRef = ref(db, '/licenseCodes');
                const snapshot = await get(licensesRef);
                if (snapshot.exists()) {
                    const allLicenses = snapshot.val();
                    const matchedKey = Object.keys(allLicenses).find(key => allLicenses[key] === userLicense);
                    if (matchedKey) {
                        await setDoc(doc(firestore, "activatedLicenses", userEmail), {
                            email: userEmail,
                            licenseCode: userLicense,
                            activatedAt: serverTimestamp()
                        });
                        await remove(ref(db, `/licenseCodes/${matchedKey}`));
                        localStorage.setItem('permanentMagicEmail', userEmail);
                        localStorage.setItem('permanentMagicLicenseCode', userLicense);
                        
                        licenseSection.classList.add('hidden');
                        initializingModal.classList.remove('hidden');
                        updateChecklist(1, true);
                        updateChecklist(2, true);
                        
                        await startApp();

                    } else {
                        licenseErrorMessage.textContent = "Invalid license code.";
                    }
                } else {
                    licenseErrorMessage.textContent = "No licenses available. Please contact support.";
                }
            } catch (error) {
                console.error("License validation failed:", error);
                licenseErrorMessage.textContent = "Error checking license. Please try again.";
            } finally {
                 submitLicenseButton.disabled = false;
                 submitLicenseButton.textContent = "Activate";
            }
        }
        
        async function generateAndDisplay(spectatorName) {
            const formattedName = spectatorName.charAt(0).toUpperCase() + spectatorName.slice(1);
            errorMessage.textContent = '';
            copyMessage.textContent = '';
            generatedUrl = `${currentURL}?id=${encodeURIComponent(customEncode(formattedName))}`;

            qrcodeContainer.innerHTML = '';
            // New QR code width to fit the container (256px container - 32px padding)
            QRCode.toCanvas(generatedUrl, { errorCorrectionLevel: 'H', width: 224 }, (error, canvas) => {
                if (error) {
                    errorMessage.textContent = 'Failed to generate QR code.';
                    return;
                }
                qrCanvasElement = canvas;
                qrcodeContainer.appendChild(canvas);
            });
            
            outputSection.classList.remove('hidden');
            dotsContainer.classList.remove('hidden');
            // disclaimerText remains hidden as it's hidden by default in this flow

            requestAnimationFrame(() => {
                drawPreview(formattedName);
                setTimeout(() => {
                    qrContainer.classList.add('visible');
                    previewContainer.classList.add('visible');
                }, 50);
            });
        }

        function drawPreview(spectatorName) {
            const ctx = previewCanvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = previewCanvas.getBoundingClientRect();
            previewCanvas.width = rect.width * dpr;
            previewCanvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const { clientWidth, clientHeight } = previewCanvas;
            const centerX = clientWidth / 2;
            const centerY = clientHeight / 2;
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, Math.sqrt(centerX**2 + centerY**2));
            gradient.addColorStop(0, '#1a1a1a');
            gradient.addColorStop(1, '#000000');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, clientWidth, clientHeight);

            ctx.fillStyle = '#e0e0e0';
            ctx.textAlign = 'center';
            ctx.font = '22px Cinzel';
            ctx.fillText(`Hi ${spectatorName},`, centerX, 40);
            ctx.font = '14px Cinzel';
            const lastTextY = wrapText(ctx, 'Please think of one of the ESP symbols below.', centerX, 70, clientWidth - 40, 20);
            
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = Math.min(clientWidth, clientHeight) / 100;
            ctx.lineCap = 'round';
            const symbolAreaYStart = lastTextY + 30;
            const symbolAreaHeight = clientHeight - symbolAreaYStart - 20;
            const minDim = Math.min(clientWidth, symbolAreaHeight);
            const cellSize = minDim / 3;
            const symbolSize = cellSize * 0.8;
            const offsetX = (clientWidth - minDim) / 2;
            const offsetY = symbolAreaYStart + (symbolAreaHeight - minDim) / 2;
            const positions = [{ r: 0, c: 0 }, { r: 0, c: 2 }, { r: 2, c: 0 }, { r: 2, c: 2 }, { r: 1, c: 1 }];
            symbols.forEach((symbol, i) => {
                const x = offsetX + (positions[i].c + 0.5) * cellSize;
                const y = offsetY + (positions[i].r + 0.5) * cellSize;
                ctx.beginPath();
                symbol.draw(ctx, x, y, symbolSize);
                ctx.stroke();
            });
        }

        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            let words = text.split(' '), line = '', currentY = y;
            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                if (context.measureText(testLine).width > maxWidth && n > 0) {
                    context.fillText(line, x, currentY);
                    line = words[n] + ' ';
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            context.fillText(line.trim(), x, currentY);
            return currentY;
        }

        function customEncode(text) {
            const charMap={'a':'@','b':'8','c':'[','d':')','e':'3','f':'F','g':'6','h':'#','i':'!','j':'J','k':'K','l':'1','m':'M','n':'^','o':'0','p':'P','q':'9','r':'R','s':'$','t':'+','u':'U','v':'V','w':'W','x':'X','y':'Y','z':'2',' ':'_'};
            return text.toLowerCase().split('').map(char => charMap[char] || char).join('');
        }

        function showFullscreenQR(url) {
            fullscreenQrContainer.innerHTML = '';
            const size = Math.min(window.innerWidth, window.innerHeight) * 0.8;
            QRCode.toCanvas(url, { errorCorrectionLevel: 'H', width: size, margin: 1 }, (error, canvas) => {
                if (error) return;
                fullscreenQrContainer.appendChild(canvas);
                fullscreenModal.classList.remove('hidden');
            });
        }

        async function handleGenerate(e) {
            e.preventDefault();
            const spectatorName = nameInput.value.trim() || "Guest";
            await generateAndDisplay(spectatorName);
        }
        
        function updateDots() {
            const activeIndex = Math.round(scrollWrapper.scrollLeft / scrollWrapper.clientWidth);
            dots.forEach((dot, index) => dot.classList.toggle('active', index === activeIndex));
        }

        scrollWrapper.addEventListener('scroll', updateDots);
        
        dots.forEach(dot => {
            dot.addEventListener('click', () => {
                scrollWrapper.scrollTo({
                    left: parseInt(dot.dataset.index) * scrollWrapper.clientWidth,
                    behavior: 'smooth'
                });
            });
        });

        qrcodeContainer.addEventListener('click', () => { if (generatedUrl) showFullscreenQR(generatedUrl); });
        closeModalButton.addEventListener('click', () => fullscreenModal.classList.add('hidden'));
        fullscreenModal.addEventListener('click', (e) => { if (e.target === fullscreenModal) fullscreenModal.classList.add('hidden'); });

        licenseForm.addEventListener('submit', handleLicenseSubmit);
        qrForm.addEventListener('submit', handleGenerate);

        initialize();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').catch(err => console.log('Service worker registration failed: ', err));
            });
        }
    </script>
</body>

</html>